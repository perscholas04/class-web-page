import{__awaiter as e,__generator as r}from"../../node_modules/tslib/tslib.es6.js";import{Auth as n}from"aws-amplify";import t from"lodash/get";import i from"lodash/pickBy";import{createMachine as s,sendUpdate as a}from"xstate";import{runValidators as o}from"../../validators/index.js";import{clearError as d,clearFormValues as c,clearTouched as u,clearValidationError as l,handleInput as m,handleSubmit as p,handleBlur as g,parsePhoneNumber as f,setCredentials as v,setFieldErrors as U,setRemoteError as h,setCodeDeliveryDetails as E,setUser as S}from"./actions.js";function b(b){var y=b.services;return s({id:"signUpActor",initial:"init",states:{init:{always:[{target:"confirmSignUp",cond:"shouldInitConfirmSignUp"},{target:"signUp"}]},signUp:{type:"parallel",exit:["clearError","clearFormValues","clearTouched"],states:{validation:{initial:"pending",states:{pending:{invoke:{src:"validateSignUp",onDone:{target:"valid",actions:"clearValidationError"},onError:{target:"invalid",actions:"setFieldErrors"}}},valid:{entry:"sendUpdate"},invalid:{entry:"sendUpdate"}},on:{CHANGE:{actions:"handleInput",target:".pending"},BLUR:{actions:"handleBlur",target:".pending"}}},submission:{initial:"idle",states:{idle:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"validate"},FEDERATED_SIGN_IN:"federatedSignIn"}},federatedSignIn:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"federatedSignIn",onDone:"#signUpActor.resolved",onError:{actions:"setRemoteError"}}},validate:{entry:"sendUpdate",invoke:{src:"validateSignUp",onDone:{target:"pending",actions:"clearValidationError"},onError:{target:"idle",actions:"setFieldErrors"}}},pending:{tags:["pending"],entry:["parsePhoneNumber","sendUpdate","clearError"],invoke:{src:"signUp",onDone:[{cond:"shouldSkipConfirm",target:"skipConfirm",actions:["setUser"]},{target:"resolved",actions:["setUser","setCredentials","setCodeDeliveryDetails"]}],onError:{target:"idle",actions:"setRemoteError"}}},skipConfirm:{invoke:{src:"signIn",onDone:{target:"#signUpActor.resolved",actions:"setUser"},onError:{target:"idle",actions:"setRemoteError"}}},resolved:{type:"final",always:"#signUpActor.confirmSignUp"}}}}},confirmSignUp:{initial:"edit",states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},CHANGE:{actions:"handleInput"},BLUR:{actions:"handleBlur"},RESEND:"resend"}},resend:{tags:["pending"],entry:"sendUpdate",invoke:{src:"resendConfirmationCode",onDone:{target:"edit"},onError:[{target:"#signUpActor.resolved",actions:"setUser",cond:"isUserAlreadyConfirmed"},{target:"edit",actions:"setRemoteError"}]}},submit:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"confirmSignUp",onDone:{target:"#signUpActor.resolved",actions:["setUser"]},onError:{target:"edit",actions:"setRemoteError"}}}}},resolved:{type:"final",data:function(e,r){var n=e.authAttributes,i=n.username,s=n.password;return{user:t(r,"data.user")||e.user,authAttributes:{username:i,password:s}}}}}},{guards:{isUserAlreadyConfirmed:function(e,r){return"User is already confirmed."===r.data.message},shouldInitConfirmSignUp:function(e){return e.intent&&"confirmSignUp"===e.intent},shouldSkipConfirm:function(e,r){return r.data.userConfirmed}},actions:{clearError:d,clearFormValues:c,clearTouched:u,clearValidationError:l,handleInput:m,handleSubmit:p,handleBlur:g,parsePhoneNumber:f,setCredentials:v,setFieldErrors:U,setRemoteError:h,setCodeDeliveryDetails:E,setUser:S,sendUpdate:a()},services:{signIn:function(i,s){return e(this,void 0,void 0,(function(){var e,s,a,o,d;return r(this,(function(r){switch(r.label){case 0:return e=i.user,s=i.authAttributes,a=i.formValues,o=t(e,"username")||t(s,"username"),d=t(a,"password"),[4,n.signIn(o,d)];case 1:return[2,r.sent()]}}))}))},confirmSignUp:function(i,s){return e(this,void 0,void 0,(function(){var e,s,a,o,d,c;return r(this,(function(r){switch(r.label){case 0:return e=i.user,s=i.authAttributes,a=i.formValues,o=a.confirmation_code,d=t(e,"username")||t(s,"username"),c=s.password,[4,y.handleConfirmSignUp({username:d,code:o})];case 1:return r.sent(),[4,n.signIn(d,c)];case 2:return[2,r.sent()]}}))}))},resendConfirmationCode:function(i,s){return e(this,void 0,void 0,(function(){var e,s,a;return r(this,(function(r){return e=i.user,s=i.authAttributes,a=t(e,"username")||t(s,"username"),[2,n.resendSignUp(a)]}))}))},federatedSignIn:function(t,i){return e(this,void 0,void 0,(function(){var e;return r(this,(function(r){switch(r.label){case 0:return e=i.data.provider,[4,n.federatedSignIn({provider:e})];case 1:return[2,r.sent()]}}))}))},signUp:function(n,t){return e(this,void 0,void 0,(function(){var e,t,s,a,o,d,c;return r(this,(function(r){switch(r.label){case 0:return e=n.formValues,t=n.loginMechanisms,s=t[0],o=(a=e)[void 0===s?"username":s],d=a.password,c=i(e,(function(e,r){switch(r){case"address":case"birthdate":case"email":case"family_name":case"gender":case"given_name":case"locale":case"middle_name":case"name":case"nickname":case"phone_number":case"picture":case"preferred_username":case"profile":case"updated_at":case"website":case"zoneinfo":return!0;default:return r.startsWith("custom:")}})),[4,y.handleSignUp({username:o,password:d,attributes:c})];case 1:return[2,r.sent()]}}))}))},validateSignUp:function(n,t){return e(this,void 0,void 0,(function(){return r(this,(function(e){return[2,o(n.formValues,n.touched,n.passwordSettings,[y.validateFormPassword,y.validateConfirmPassword,y.validatePreferredUsername,y.validateCustomSignUp])]}))}))}}})}export{b as createSignUpMachine};
